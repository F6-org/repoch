{"version":3,"sources":["../../src/ajax/index.js"],"names":["ajLocks","callbacks","processResponse","result","status","res","data","code","msg","url","encodeURIComponent","window","location","href","replace","Promise","reject","get","options","reqUrl","indexOf","cache","axios","then","catch","post","raw","isCommonError","process","env","NODE_ENV","console","error","registerCallback","callback"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AAEA,IAAMA,UAAU,EAAhB;AACA,IAAMC,YAAY,EAAlB;AACA,IAAMC,kBAAkB,SAAlBA,eAAkB,CAACC,MAAD,EAAY;AAChC,YAAOA,OAAOC,MAAd;AACI,aAAK,GAAL;AACI,gBAAIC,MAAMF,OAAOG,IAAjB;AACA,oBAAOD,IAAIE,IAAX;AACI,qBAAK,MAAL;AACA,qBAAK,QAAL;AACI,2BAAO,EAAED,MAAMD,IAAIC,IAAZ,EAAkBE,KAAKH,IAAIG,GAA3B,EAAP;;AAEJ,qBAAK,MAAL;AACA,qBAAK,QAAL;AACI,wBAAIP,UAAUI,IAAIE,IAAd,CAAJ,EAAyB;AACrBN,kCAAUI,IAAIE,IAAd,EAAoBF,GAApB;AACH,qBAFD,MAEO;AACH,gDACIA,IAAIC,IAAJ,CAASG,GAAT,IACA,6CACAC,mBAAmBC,OAAOC,QAAP,CAAgBC,IAAnC,CAHJ,EAII,EAAEC,SAAS,IAAX,EAJJ;AAMH;;AAED;;AAEJ,qBAAK,MAAL;AACA,qBAAK,QAAL;AACI,wBAAIb,UAAUI,IAAIE,IAAd,CAAJ,EAAyB;AACrBN,kCAAUI,IAAIE,IAAd,EAAoBF,GAApB;AACH,qBAFD,MAEO;AACH,gDACIA,IAAIC,IAAJ,CAASG,GAAT,oBACcC,mBAAmBC,OAAOC,QAAP,CAAgBC,IAAnC,CAFlB,EAGI,EAAEC,SAAS,IAAX,EAHJ;AAKH;;AAED;AACJ;AACI;AAlCR;;AAqCA,mBAAOC,QAAQC,MAAR,CAAeX,GAAf,CAAP;;AAEJ;AACI,mBAAOU,QAAQC,MAAR,CAAe,OAAf,CAAP;AA3CR;AA6CH,CA9CD;;AAgDO,IAAMC,oBAAM,SAANA,GAAM,CAACR,GAAD,EAAMH,IAAN,EAAYY,OAAZ,EAAwB;AACvC,QAAIC,SAASV,GAAb;AACA,QAAIH,IAAJ,EAAU;AACN,YAAIA,KAAK,CAAL,MAAY,GAAZ,IAAmBA,KAAK,CAAL,MAAY,GAAnC,EAAwC;AACpC,mCAAQ,KAAR,EAAe,qBACX,oDADW,GAC4CA,IAD5C,GACmD,GADlE;AAGH;AACDa,kBAAUA,OAAOC,OAAP,CAAe,GAAf,IAAsB,CAAtB,GAA0B,GAA1B,GAAgC,GAA1C;AACAD,kBAAU,OAAOb,IAAP,KAAgB,QAAhB,GAA2BA,IAA3B,GAAkC,2BAAYA,IAAZ,CAA5C;AACH;;AAEDa,cAAUA,OAAOC,OAAP,CAAe,GAAf,IAAsB,CAAtB,GAA0B,GAA1B,GAAgC,GAA1C;AACAD,cAAU,UAAU,qBAApB;;AAEA,QAAID,OAAJ,EAAa;AACT,eAAOA,QAAQG,KAAf;AACH;;AAED,QAAIrB,QAAQmB,MAAR,CAAJ,EAAqB;AACrBnB,YAAQmB,MAAR,IAAkB,IAAlB;;AAEA,WAAOG,gBAAML,GAAN,CAAUE,MAAV,EAAkBD,OAAlB,EAA2BK,IAA3B,CAAgC,UAACpB,MAAD,EAAY;AAC/C,eAAOH,QAAQmB,MAAR,CAAP;AACA,eAAOhB,MAAP;AACH,KAHM,EAGJqB,KAHI,CAGE,kBAAU;AACf,eAAOxB,QAAQmB,MAAR,CAAP;AACA,eAAOJ,QAAQC,MAAR,CAAe,OAAf,CAAP;AACH,KANM,EAMJO,IANI,CAMCrB,eAND,CAAP;AAOH,CA7BM;;AA+BA,IAAMuB,sBAAO,SAAPA,IAAO,CAAChB,GAAD,EAAMH,IAAN,EAAYY,OAAZ,EAAwB;AACxC,QAAIlB,QAAQS,GAAR,CAAJ,EAAkB;AAClBT,YAAQS,GAAR,IAAe,IAAf;;AAEA,QAAIS,WAAWA,QAAQQ,GAAvB,EAA4B;AACxBpB,aAAK,MAAL,IAAe,qBAAf;AACA,eAAOY,QAAQQ,GAAf;AACH,KAHD,MAGO,IAAI,OAAOpB,IAAP,KAAgB,QAApB,EAA8B;AACjCA,gBAAQA,SAAS,EAAT,GAAc,EAAd,GAAmB,GAA3B;AACAA,gBAAQ,UAAU,qBAAlB;AACH,KAHM,MAGA,IAAI,QAAOA,IAAP,yCAAOA,IAAP,OAAgB,QAApB,EAA8B;AACjCA,eAAOA,QAAQ,EAAf;AACAA,aAAK,MAAL,IAAe,qBAAf;AACAA,eAAO,2BAAYA,IAAZ,CAAP;AACH;;AAED,WAAOgB,gBAAMG,IAAN,CAAWhB,GAAX,EAAgBH,IAAhB,EAAsBY,OAAtB,EAA+BK,IAA/B,CAAoC,UAACpB,MAAD,EAAY;AACnD,eAAOH,QAAQS,GAAR,CAAP;AACA,eAAON,MAAP;AACH,KAHM,EAGJqB,KAHI,CAGE,kBAAU;AACf,eAAOxB,QAAQS,GAAR,CAAP;AACA,eAAOM,QAAQC,MAAR,CAAe,OAAf,CAAP;AACH,KANM,EAMJO,IANI,CAMCrB,eAND,CAAP;AAOH,CAvBM;;AAyBA,IAAMyB,wCAAgB,SAAhBA,aAAgB,MAAO;AAChC,QAAIC,QAAQC,GAAR,CAAYC,QAAZ,KAAyB,aAA7B,EAA4C;AACxCC,gBAAQC,KAAR,CAAc3B,GAAd;AACH;AACD,WAAOA,QAAQA,IAAIE,IAAJ,IAAY,MAAZ,IAAsBF,IAAIE,IAAJ,IAAY,MAA1C,CAAP;AACH,CALM;;AAOA,IAAM0B,8CAAmB,SAAnBA,gBAAmB,CAAC1B,IAAD,EAAO2B,QAAP,EAAoB;AAChDjC,cAAUM,IAAV,IAAkB2B,QAAlB;AACH,CAFM","file":"index.js","sourcesContent":["import axios from './lib/axios';\nimport jsonToQuery from '../format/json-to-query';\nimport { jumpPage } from '../jump-page';\nimport warning from 'warning';\nimport { gettid } from '../logger';\n\nconst ajLocks = {};\nconst callbacks = {};\nconst processResponse = (result) => {\n    switch(result.status) {\n        case 200:\n            let res = result.data;\n            switch(res.code) {\n                case 100000:\n                case '100000':\n                    return { data: res.data, msg: res.msg };\n\n                case 100002:\n                case '100002':\n                    if (callbacks[res.code]) {\n                        callbacks[res.code](res);\n                    } else {\n                        jumpPage(\n                            res.data.url ||\n                            \"http://passport.weibo.cn/signin/login?r=\" +\n                            encodeURIComponent(window.location.href),\n                            { replace: true }\n                        );\n                    }\n\n                    break;\n\n                case 100004:\n                case '100004':\n                    if (callbacks[res.code]) {\n                        callbacks[res.code](res);\n                    } else {\n                        jumpPage(\n                            res.data.url || \n                            `/errpage?r=${encodeURIComponent(window.location.href)}`, \n                            { replace: true }\n                        );\n                    }\n\n                    break;\n                default:\n                    break;\n            }\n\n            return Promise.reject(res);\n\n        default:\n            return Promise.reject('服务器错误');\n    }\n}\n\nexport const get = (url, data, options) => {\n    let reqUrl = url;\n    if (data) {\n        if (data[0] === '?' || data[0] === '&') {\n            warning(false, '[utils/io/ajax] ' +\n                'do not put \"?\" or \"$\" as the first byte of data, \"' + data + '\"'\n            );\n        }\n        reqUrl += reqUrl.indexOf('?') < 0 ? '?' : '&';\n        reqUrl += typeof data === 'string' ? data : jsonToQuery(data);\n    }\n\n    reqUrl += reqUrl.indexOf('?') < 0 ? '?' : '&';\n    reqUrl += '_lid=' + gettid();\n\n    if (options) {\n        delete options.cache;\n    }\n\n    if (ajLocks[reqUrl]) return;\n    ajLocks[reqUrl] = true;\n\n    return axios.get(reqUrl, options).then((result) => {\n        delete ajLocks[reqUrl];\n        return result;\n    }).catch(result => {\n        delete ajLocks[reqUrl];\n        return Promise.reject('服务器错误');\n    }).then(processResponse);\n}\n\nexport const post = (url, data, options) => {\n    if (ajLocks[url]) return;\n    ajLocks[url] = true;\n\n    if (options && options.raw) {\n        data['_lid'] = gettid();\n        delete options.raw;\n    } else if (typeof data === 'string') {\n        data += data === '' ? '' : '&';\n        data += '_lid=' + gettid();\n    } else if (typeof data === 'object') {\n        data = data || {};\n        data['_lid'] = gettid();\n        data = jsonToQuery(data);\n    }\n        \n    return axios.post(url, data, options).then((result) => {\n        delete ajLocks[url];\n        return result;\n    }).catch(result => {\n        delete ajLocks[url];\n        return Promise.reject('服务器错误');\n    }).then(processResponse);\n}\n\nexport const isCommonError = res => {\n    if (process.env.NODE_ENV === 'development') {\n        console.error(res);\n    }\n    return res && (res.code == 100002 || res.code == 100004);\n}\n\nexport const registerCallback = (code, callback) => {\n    callbacks[code] = callback;\n}\n\n"]}