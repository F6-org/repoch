{"version":3,"sources":["../../../src/upload/lib/uploader.js"],"names":["node","opts","that","_uploadBtn","_image","_canvas","_fileTypeList","_fileList","_opts","width","height","maxFileNum","maxFileSize","fileFilter","isOriginal","imgMaxWidth","imgMaxHeight","upServer","fileExtensions","checkSize","withSize","watermark","getBase64","uploaded","uploading","error","readed","storageType","callback","data","eventFun","fileSelected","evt","stopPropagation","preventDefault","init","toArray","target","files","fileNum","length","ret","msg","type","code","i","size","FILE_SIZE_MB","utilFun","getFileExtType","name","toLowerCase","indexOf","join","fileReaderFun","handleFile","fileReader","FileReader","onload","onLoad","onabort","onAbort","onerror","onError","onloadstart","onLoadstart","onloadend","onLoadend","file","shift","filename","readAsDataURL","_handleImage","_imageData","result","_imageName","src","MIME_EXT_MAPPING","split","Image","document","createElement","_handled","imageHandler","crop","addWatermark","progressFun","toDataURL","_hasDraw","srcW","srcH","destW","destH","widthRatio","heightRatio","scale","sx","sy","swidth","sheight","Math","abs","getContext","drawImage","text","ctx","save","_alpha","_w","_h","_delta","_d","sqrt","_fs","font","fillStyle","_textWidth","measureText","_rDelta","translate","rotate","atan","fillText","restore","onProgress","percentLoaded","round","loaded","total","progress","response","imgBase64","encode","onUploadProgress","then","catch","str","replace","_tmp","undefined","DOMFun","setUploadBtnAttr","uploadBtn","FILE_FILTER","acceptList","len","push","removeAttribute","setAttribute","uploaderContainer","parentNode","html","innerHTML","destroy","img","doc","all","pseudoArrayObj","slice","call","e","arr","l"],"mappings":"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","file":"uploader.js","sourcesContent":["import querySelectorAll from 'dom-helpers/query/querySelectorAll';\nimport addEventListener from 'dom-helpers/events/on';\nimport { post } from '../../ajax';\n\nvar FILE_SIZE_MB = 1024 * 1024;\nvar MIME_EXT_MAPPING = {\n    //图像\n    'gif'  : 'image/gif',\n    'jpeg' : 'image/jpeg',\n    'jpg'  : 'image/jpeg',\n    'png'  : 'image/png',\n    'tif'  : 'image/tiff',\n    'tiff' : 'image/tiff',\n    'bmp'  : 'image/bmp',\n    //文档\n    'doc'  : 'application/msword',\n    'docx' : 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    'dot'  : 'application/msword',\n    'ppt'  : 'application/vnd.ms-powerpoint',\n    'pptx' : 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n    'pps'  : 'application/vnd.ms-powerpoint',\n    'pot'  : 'application/vnd.ms-powerpoint',\n    'xls'  : 'application/vnd.ms-excel',\n    'xlsx' : 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n    'xlc'  : 'application/vnd.ms-excel',\n    'xlm'  : 'application/vnd.ms-excel',\n    'xlt'  : 'application/vnd.ms-excel',\n    'pdf'  : 'application/pdf',\n    'mpp'  : 'application/vnd.ms-project',\n    'txt'  : 'text/plain',\n    'text' : 'text/plain',\n    'wps'  : 'application/vnd.ms-works',\n    'wdb'  : 'application/vnd.ms-works',\n    'rtf'  : 'application/rtf,text/rtf',\n    'htm'  : 'text/html',\n    'html' : 'text/html',\n    'xhtml': 'application/xhtml+xml',\n    'xml'  : 'application/xml,text/xml',\n    'js'   : 'text/javascript,application/javascript',\n    'json' : 'application/json',\n    'css'  : 'text/css',\n    'csv'  : 'text/csv',\n    'zip'  : 'aplication/zip',\n    'dtd'  : 'application/xml-dtd',\n    'asf'  : 'application/vnd.ms-asf',\n    //音频\n    '3gpp' : 'audio/3gpp,video/3gpp',\n    'ac3'  : 'audio/ac3',\n    'ogg'  : 'application/ogg,audio/ogg',\n    'mp3'  : 'audio/mpeg',\n    'mp2'  : 'audio/mpeg,video/mpeg',\n    'mp4'  : 'audio/mp4,video/mp4',\n    'au'   : 'audio/basic',\n    //视频\n    'mpeg' : 'video/mpeg',\n    'mpg'  : 'video/mpeg'\n};\nvar FILE_FILTER = {\n    img: \"jpg,png,gif,jpeg,bmp\",\n    doc: \"doc,docx,xls,xlsx,ppt,pptx,pdf,txt\",\n    all: \"jpg,png,gif,jpeg,bmp,doc,docx,xls,xlsx,ppt,pptx,pdf,txt\"\n};\n\nvar toArray = function(pseudoArrayObj) {\n    try{\n        return slice.call(pseudoArrayObj);\n    } catch(e) {\n        var arr = [];\n        for(var i = 0, l = pseudoArrayObj.length; i < l; i++) {\n            arr[i] = pseudoArrayObj[i];\n        }\n        return arr;\n    }\n};\n\nexport default function(node, opts) {\n    var that = {}, \n        _uploadBtn,\n        _image, _canvas,\n        _fileTypeList, _fileList,\n        _opts = Object.assign({}, {\n            width: 230,\n            height: 140,\n            maxFileNum: 1,\n            maxFileSize: 5,\n            fileFilter: 'img',\n            isOriginal: true,\n            imgMaxWidth: 512,\n            imgMaxHeight: 200,\n            upServer: '',\n            fileExtensions: '',\n            checkSize: false,\n            withSize: false,\n            watermark: \"\",\n            getBase64: function(){},\n            uploaded: function() {},\n            uploading: function() {},\n            error: function() {},\n            readed: function() {},\n            storageType: 2, // 1 = 图床，2 = 微盘\n            callback: function() {},\n            data: {}\n        }, opts);\n\n    var eventFun = {\n        fileSelected: function(evt) {\n            evt.stopPropagation();\n            evt.preventDefault();\n            init();\n            _fileList = toArray(evt.target.files || []);\n            var fileNum = _fileList.length;\n            if (!fileNum) return;\n\n            //判断文件数量是否合法；\n            if (fileNum > _opts.maxFileNum) {\n                var ret = {\n                    msg: \"最多选择\" + _opts.maxFileNum + \"个文件\",\n                    type: 'error',\n                    code: 110002\n                }\n                _opts.error && _opts.error(ret);\n                return;\n            }\n            for (var i = 0; i < fileNum; i++) {\n                //判断是否有文件的大小不合法；\n                if (_fileList[i].size > _opts.maxFileSize * FILE_SIZE_MB) {\n                    var ret = {\n                        msg: \"文件大小超出\" + (_opts.maxFileSize) + \"M\",\n                        type: 'error',\n                        code: 110003\n                    }\n                    _opts.error && _opts.error(ret);\n                    return;\n                }\n                //判断文件类型是否合法；\n                var type = utilFun.getFileExtType(_fileList[i].name).toLowerCase();\n                if (_fileTypeList.indexOf(type) < 0) {\n                    var ret = {\n                        msg: \"文件类型错误，仅支持上传\" + _fileTypeList.join(',') + \"类型文件\",\n                        type: 'error',\n                        code: 110004\n                    }\n                    _opts.error && _opts.error(ret);\n                    return;\n                }\n            }\n            //通知文件处理模块，文件已经选择完\n            fileReaderFun.handleFile(_fileList);\n            // progressFun.uploading();\n        }\n    };\n\n    var fileReaderFun = {\n        handleFile: function() {\n            if (_fileList.length == 0) return;\n\n            var fileReader = new FileReader();\n            fileReader.onload = fileReaderFun.onLoad;\n            // fileReader.onprogress = fileReaderFun.onProgress;\n            fileReader.onabort = fileReader.onAbort;\n            fileReader.onerror = fileReaderFun.onError;\n            fileReader.onloadstart = fileReaderFun.onLoadstart;\n            fileReader.onloadend = fileReaderFun.onLoadend;\n            var file = _fileList.shift();\n            fileReader.filename = file.name;\n            fileReader.readAsDataURL(file); //读取base64数据\n        },\n        onLoad: function(evt) {\n            var _handleImage = false;//标记是否需要对图片做像素处理\n            \n            if (_opts.fileFilter === 'img' && ((_opts.imgMaxWidth && _opts.imgMaxHeight) ||\n                    _opts.withSize || _opts.checkSize || _opts.watermark)\n            ) {\n                _handleImage = true;\n            }\n            //如果是图片，且需要，则先裁剪再展示\n            var _imageData = evt.target.result;\n            var _imageName = evt.target.filename;\n\n            if (_handleImage) {\n                var type = utilFun.getFileExtType(_imageName);\n                var src = 'data:' + MIME_EXT_MAPPING[type] + ';base64,'\n                    + _imageData.split(',')[1];\n                if (!_image) _image = new Image();\n                if (!_canvas) _canvas = document.createElement('canvas');\n\n                _image.onload = function () {\n                    var _handled = false;\n                    //图片像素处理\n                    if (_opts.checkSize && !imageHandler.checkSize()) {\n                        return;\n                    }\n                    if (_opts.imgMaxWidth && _opts.imgMaxHeight) {\n                        imageHandler.crop();\n                        _handled = true;\n                    }\n                    if (_opts.watermark) {\n                        imageHandler.addWatermark();\n                        _handled = true;\n                    }\n                    _handled?\n                        progressFun.readed(_canvas.toDataURL(), _imageName):\n                        progressFun.readed(_imageData, _imageName);\n                }\n                _image.src = src;\n            } else {\n                progressFun.readed(_imageData, _imageName);\n            }\n        },\n        // onProgress: function(evt) {\n            // if (evt.lengthComputable) {\n            //     var percentLoaded = Math.round((evt.loaded / evt.total) * 100);\n            //     if (percentLoaded < 100) {\n            //         progressFun.uploading(percentLoaded);\n            //     }\n            // }\n        // },\n        onAbort: function(evt) {\n        },\n        onError: function(evt) {\n        },\n        onLoadstart: function(evt) {\n        },\n        onLoadend: function(evt) {\n        }\n    };\n\n    var _hasDraw = false;\n    var imageHandler = {\n        crop: function() {\n            if (!_canvas || !_image) return;\n            var srcW = _image.width,\n                srcH = _image.height,\n                destW = _opts.imgMaxWidth,\n                destH = _opts.imgMaxHeight,\n                widthRatio = srcW / destW,\n                heightRatio = srcH / destH,\n                scale, //缩放比例，原图尺寸和目标尺寸的对比\n                sx, //原图采集开始的x坐标\n                sy, //原图采集开始的y坐标\n                swidth, //原图采集区域的宽度\n                sheight; //原图采集区域的高度\n\n            _canvas.width = destW;\n            _canvas.height = destH;\n\n            //缩放后居中裁切\n            //匹配宽高比率小的那个边；\n            //如果宽度比大于高度比，说明要匹配高度，宽度裁切；反之亦然。\n            if (widthRatio > heightRatio) {\n                scale = heightRatio;\n                swidth = destW * scale;\n                sheight = destH * scale;\n                //居中的起始位置x坐标。\n                sx = Math.abs((swidth - srcW) / 2);\n                sy = 0;\n            } else {\n                scale = widthRatio;\n                swidth = destW * scale;\n                sheight = destH * scale;\n                //居中的起始位置y坐标。\n                sx = 0;\n                sy = Math.abs((sheight - srcH) / 2);\n            }\n            _canvas.getContext('2d').drawImage(_image, sx, sy, swidth, sheight, 0, 0, destW, destH);\n            _hasDraw = true;\n        },\n        checkSize:function() {\n            if (!_image)    return;\n            var srcW = _image.width,\n                srcH = _image.height,\n                destW = _opts.imgMaxWidth,\n                destH = _opts.imgMaxHeight;\n\n            if ((srcW !== destW) || (srcH !== destH)){\n                var ret = {\n                    msg: \"图片尺寸不符合规范\",\n                    type: 'error',\n                    code: 110008\n                }\n                _opts.error && _opts.error(ret);\n                return false;\n            }\n            if (!_hasDraw) {\n                _canvas.width = _image.width;\n                _canvas.height = _image.height;\n                _canvas.getContext('2d').drawImage(_image, 0, 0);\n            }\n            return true;\n        },\n        addWatermark: function() {\n            if (!_canvas) return;\n            if (!_image) return;\n            if (!_hasDraw) {\n                _canvas.width = _image.width;\n                _canvas.height = _image.height;\n                _canvas.getContext('2d').drawImage(_image, 0, 0);\n            }\n\n            var text = _opts.watermark;\n            var ctx=_canvas.getContext('2d');\n            ctx.save();\n            var _alpha = 0.1;//字体透明度\n            var _w = _canvas.width;//图片宽度\n            var _h = _canvas.height;//图片高度\n            var _delta = 0.85;\n            var _d = _delta * Math.sqrt(_w*_w + _h*_h); //图片对角线长度(减去两端留白)\n            var _fs = 500;//字体大小\n            ctx.font = _fs + \"px 宋体\";\n            ctx.fillStyle = 'rgba(0, 0, 0, ' + _alpha + ')';\n            //动态调整字体大小；\n            var _textWidth = ctx.measureText(text).width;\n            while (_textWidth > _d){\n                _fs--;\n                ctx.font = _fs + \"px 宋体\";\n                _textWidth = ctx.measureText(text).width;\n            }\n            //设置旋转中心点和旋转方向（从左下至右上）\n            var _rDelta = ((_w > _h)?_delta:(2 - _delta));\n            _rDelta = (_w === _h)?1:_rDelta;\n            ctx.translate(_w / 2, _h / 2);\n            ctx.rotate(-(Math.atan(_h / _w))*_rDelta);\n\n            ctx.fillText(text, -_textWidth/2, (_fs*0.9)/2);\n            ctx.restore();\n        }\n    };\n\n    var progressFun = {\n        onProgress: function(evt) {\n            var percentLoaded = Math.round((evt.loaded / evt.total) * 100);\n            progressFun.uploading(percentLoaded);\n        },\n        uploading: function(progress) {\n            var ret = {\n                msg: \"上传中\",\n                type: 'uploading',\n                data: progress,\n                code: 110005\n            }\n            _opts.uploading && _opts.uploading(ret);\n        },\n        uploaded: function(response) {\n            if (_opts.withSize) {\n                response.data.width = _image.width;\n                response.data.height = _image.height;\n            }\n            _opts.uploaded && _opts.uploaded(response);\n        },\n        getBase64: function(imgBase64) {\n            _opts.getBase64 && _opts.getBase64(imgBase64);\n        },\n        error: function(data) {\n            var ret = {\n                msg: \"网络繁忙，请重试！\",\n                type: 'error',\n                data: data,\n                code: 100006\n            }\n            _opts.error && _opts.error(ret);\n        },\n        readed: function(src, name) {\n            var data = Object.assign({\n                data: utilFun.encode(src),\n                storageType: _opts.storageType,\n                filename: name\n            }, _opts.data);\n\n            post(_opts.upServer, data, { onUploadProgress: progressFun.onProgress })\n            .then(function(response) {\n                response.code = 100000;\n                progressFun.uploaded(response);\n                progressFun.getBase64(utilFun.encode(src));\n                fileReaderFun.handleFile();\n            }).catch(function(response) {\n                progressFun.error(response);\n                fileReaderFun.handleFile();\n            });\n\n            var ret = {\n                msg: \"文件已获取\",\n                type: 'readed',\n                data: src,\n                code: 100007\n            };\n            _opts.readed && _opts.readed(ret);\n        }\n    };\n\n    var utilFun = {\n        encode: function(str) {\n            return str.replace(/\\&/g,'&amp;').\n                replace(/\"/g,'&quot;').\n                replace(/\\</g,'&lt;').\n                replace(/\\>/g,'&gt;').\n                replace(/\\'/g,'&#39;').\n                replace(/\\u00A0/g,'&nbsp;').\n                replace(/(\\u0020|\\u000B|\\u2028|\\u2029|\\f)/g,'&#32;');\n        },\n        getFileExtType: function(name) {\n            var _tmp = name.split('.');\n            var type = _tmp[_tmp.length - 1];\n            // 小米2读不到图片正确名字\n            if (_opts.fileFilter === 'img' && type === undefined) \n                type = 'jpg';\n\n            return type;\n        }\n    };\n\n    var DOMFun = {\n        setUploadBtnAttr: function() {\n            var uploadBtn = querySelectorAll(node, 'input[data-type=\"uploadBtn\"]')[0];\n            if (!_fileTypeList) {\n                if (_opts.fileExtensions) _fileTypeList = _opts.fileExtensions.split(',');\n                else _fileTypeList = FILE_FILTER[_opts.fileFilter].split(',');\n\n                var acceptList = [];\n                for (var i = 0, len = _fileTypeList.length; i < len; i++) {\n                    acceptList.push(MIME_EXT_MAPPING[_fileTypeList[i]]);\n                }\n                if (_opts.maxFileNum < 2) uploadBtn.removeAttribute(\"multiple\");\n                uploadBtn.setAttribute('accept', acceptList.join(','));\n            }\n            \n            addEventListener(uploadBtn, 'change', eventFun.fileSelected);\n        }\n    };\n    \n    function init() {\n        var uploadBtn = querySelectorAll(node, 'input[data-type=\"uploadBtn\"]')[0];\n        var uploaderContainer = uploadBtn.parentNode;\n        var html = uploaderContainer.innerHTML;\n\n        uploaderContainer.innerHTML = html;\n        DOMFun.setUploadBtnAttr();\n    }\n\n    init();\n    that.destroy = function() {\n        _image = _canvas = _fileTypeList = null;\n        eventFun = progressFun = utilFun = null;\n        DOMFun = fileReaderFun = imageHandler = null;\n    }\n    \n    return that;\n};\n"]}