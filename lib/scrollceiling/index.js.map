{"version":3,"sources":["../../src/scrollceiling/index.js"],"names":["ScrollCeiling","props","lock","componentWillMount","componentDidMount","componentWillUnmount","checkCeiling","vT","virtualTop","showCeilingH","refs","topnav","classList","add","showHandler","hideHandler","remove","handleTouchStart","e","scrollAnimate","window","cancelAnimationFrame","y","touches","pageY","x","pageX","touchData","touchStartT","Date","touchStartX","touchStartY","lastCurrent","isTouch","clickNav","handleTouchMove","currentX","currentY","cancelable","defaultPrevented","preventDefault","topDragDown","transformTo","offset","ReactDOM","findDOMNode","scrollpage","clientHeight","innerHeight","deltaY","touchMoveT","handleTouchEnd","endT","Math","abs","velocity","endTop","pow","loadMoreDatas","doAnimation","orign","target","realOffset","runWheelAnimate","t_delta","scrollAnimateStart","progress","leftTime","t","toFixed","delta","ceil","wheelBezier","requestAnimationFrame","top","curTop","style","WebkitTransform","mid1","mid2","ps","pe","children","renderScrollCeilingTopNav","Component","propTypes","PropTypes","number","isRequired","func"],"mappings":"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","file":"index.js","sourcesContent":["import React, { Component } from 'react';\nimport ReactDOM from 'react-dom';\nimport PropTypes from 'prop-types';\nimport './index.style.scss';\n\n/*\n* @showCeilingH: 吸顶模块展示时，页面Y轴滑动的距离\n* @loadMoreDatas：底部上滑加载更多内容\n* @renderScrollCeilingTopNav：吸顶模块\n* @showHandler: 吸顶模块吸顶时额外的交互 \n* @hideHandler: 吸顶模块不吸顶时额外的交互\n* 引用举例： \n    <ScrollCeiling\n        showCeilingH={200}\n        renderScrollCeilingTopNav={domRender}\n        loadMoreDatas={null}\n        showHandler={null}\n        hideHandler={null}\n        >\n        <p>123456</p>\n    </ScrollCeiling>\n*/\n\nclass ScrollCeiling extends Component {\n\n    static propTypes = {\n        showCeilingH: PropTypes.number.isRequired,\n        // renderScrollCeilingTopNav: PropTypes.element.isRequired, //吸顶模块的渲染\n        loadMoreDatas: PropTypes.func, // 页面底部上滑，加载更多内容的回调函数 \n        showHandler: PropTypes.func, // 吸顶模块展示后的回调函数\n        hideHandler: PropTypes.func, // 吸顶模块不展示后的回调函数\n    }\n\n    constructor(props) {\n        super(props);\n        this.touchData = {\n            touchStartY: 0,\n            touchStartX: 0,\n            currentY: 0,\n            currentX: 0,\n            deltaY: 0,\n            lastCurrent: 0,\n            touchStartT: 0,\n            touchMoveT: 0,\n            isTouch: false,\n        };\n        this.clickNav = true;\n        this.virtualTop = 0;\n        this.topDragDown = false;\n    }\n\n    lock = false;\n\n    componentWillMount = () => {\n\n    }\n\n    componentDidMount = () => {\n    }\n\n    componentWillUnmount = () => {\n\n    }\n\n    checkCeiling = () => {\n        let vT = -this.virtualTop;\n        if (vT >= this.props.showCeilingH) {\n            this.refs.topnav.classList.add('show');\n            this.props.showHandler && this.props.showHandler();\n            this.lock = false;\n        }\n        else {\n            if (!this.lock) {\n                this.props.hideHandler && this.props.hideHandler();\n                this.lock = true;\n            }\n            this.refs.topnav.classList.remove('show');\n        }\n    }\n\n    handleTouchStart = (e) => {\n        if (this.scrollAnimate) {\n            window.cancelAnimationFrame(this.scrollAnimate);\n        }\n        this.checkCeiling();\n        let y = e.touches[0].pageY,\n            x = e.touches[0].pageX;\n\n        this.touchData.touchStartT = +new Date();\n        this.touchData.touchStartX = x;\n        this.touchData.touchStartY = y;\n        this.touchData.lastCurrent = y;\n        this.touchData.isTouch = false;\n        this.clickNav = false;\n    }\n\n    handleTouchMove = (e) => {\n        // this.clickNav = false\n        this.touchData.currentX = e.touches[0].pageX;\n        this.touchData.currentY = e.touches[0].pageY;\n        if (e.cancelable) {\n            // 判断默认行为是否已经被禁用\n            if (!e.defaultPrevented) {\n                e.preventDefault();\n            }\n        }\n        if (this.virtualTop >= 0 && this.touchData.currentY - this.touchData.touchStartY > 0) {\n            //顶部下拉\n            this.topDragDown = true;\n            this.transformTo(0);\n        }\n        else {\n            this.topDragDown = false;\n            let offset = this.touchData.currentY - this.touchData.lastCurrent;\n            if (-this.virtualTop > ReactDOM.findDOMNode(this.refs.scrollpage).clientHeight - window.innerHeight) {\n                if (offset > 0) {\n                    this.transformTo(this.virtualTop + offset);\n                }\n                else {\n                    this.transformTo(this.virtualTop);\n                }\n            }\n            else {\n                this.transformTo(this.virtualTop + offset);\n            }\n        }\n        this.touchData.deltaY = this.touchData.currentY - this.touchData.lastCurrent;\n        this.touchData.lastCurrent = this.touchData.currentY;\n        this.touchData.touchMoveT = +new Date();\n        this.checkCeiling();\n    }\n\n    handleTouchEnd = (e) => {\n        let endT = +new Date();\n        if (endT - this.touchData.touchStartT < 300 && Math.abs(this.touchData.lastCurrent - this.touchData.touchStartY) < 30) return; //click\n        this.touchData.isTouch = true;\n        if (this.topDragDown) {\n            this.transformTo(0);\n        } else {\n            //calc endtop\n            let velocity = this.touchData.deltaY * 1 / (endT - this.touchData.touchMoveT);\n            let endTop = this.virtualTop + Math.pow(velocity, 3);\n            // Math.abs(velocity)// - Math.sqrt(Math.abs(velocity)))\n            if (endTop >= 0) {\n                endTop = 0;\n            } else if (endTop <= -ReactDOM.findDOMNode(this.refs.scrollpage).clientHeight + window.innerHeight) {\n                endTop = -ReactDOM.findDOMNode(this.refs.scrollpage).clientHeight + window.innerHeight;\n                //上滑加载更多数据\n                this.props.loadMoreDatas && this.props.loadMoreDatas();\n            }\n            this.doAnimation(this.virtualTop, endTop);\n        }\n        this.checkCeiling()\n    }\n\n    doAnimation = (orign, target) => {\n        let realOffset = target - orign;\n        let runWheelAnimate = (t_delta) => {\n            if (!this.scrollAnimateStart) this.scrollAnimateStart = t_delta;\n            let progress = t_delta - this.scrollAnimateStart,\n                leftTime = 300,\n                t = +(progress / (leftTime)).toFixed(4),\n                delta = Math.ceil(this.wheelBezier(t, [.8, .8], [.8, 1])[1] * realOffset)\n            if (!this.clickNav && orign + delta >= 0) {\n                //上滑至顶部\n                this.transformTo(0)\n                window.cancelAnimationFrame(this.scrollAnimate)\n            }\n            else {\n                if (t >= 1) {\n                    this.transformTo(target)\n                } else {\n                    this.transformTo(orign + delta)\n                }\n            }\n            !this.clickNav && this.checkCeiling()\n            if (progress <= leftTime) {\n                window.requestAnimationFrame(runWheelAnimate);\n            } else {\n                window.cancelAnimationFrame(this.scrollAnimate)\n                this.scrollAnimateStart = 0\n            }\n        }\n        this.scrollAnimate = window.requestAnimationFrame(runWheelAnimate)\n\n    }\n\n    transformTo(top) {\n        let curTop = top > 0 ? 0 : top;\n        this.refs.scrollpage.style.WebkitTransform = 'translate(0,' + (curTop) + 'px' + ')';\n        this.virtualTop = curTop\n    }\n\n    wheelBezier(t, mid1, mid2) {\n        // 0 < t < 1\n        let ps = [0, 0],\n            pe = [1, 1];\n        return [\n            (1 - t) * (1 - t) * (1 - t) * ps[0] + 3 * (1 - t) * (1 - t) * t * mid1[0] + 3 * (1 - t) * t * t * mid2[0] + t * t * t * pe[0],\n            (1 - t) * (1 - t) * (1 - t) * ps[1] + 3 * (1 - t) * (1 - t) * t * mid1[1] + 3 * (1 - t) * t * t * mid2[1] + t * t * t * pe[1]\n        ]\n    }\n\n    render() {\n        return (\n            <div className=\"scroll-page-root\">\n                <div className=\"scroll-page-wrapper\" ref=\"scrollpage\"\n                    onTouchStart={this.handleTouchStart}\n                    onTouchMove={this.handleTouchMove}\n                    onTouchEnd={this.handleTouchEnd}>\n                    {\n                        //页面\n                        this.props.children\n                    }\n                </div>\n                <div className=\"fixed-top\" ref=\"topnav\">\n                    {\n                        //吸顶模块\n                        this.props.renderScrollCeilingTopNav && this.props.renderScrollCeilingTopNav()\n                    }\n                </div>\n            </div>\n        )\n    }\n\n}\n\nexport default ScrollCeiling"]}